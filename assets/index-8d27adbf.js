var tt=Object.defineProperty;var et=(r,t,e)=>t in r?tt(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e;var a=(r,t,e)=>(et(r,typeof t!="symbol"?t+"":t,e),e);import{T as w,S as A,M,a as G,U as st,b as it,B as rt,A as z,G as U,C as F,F as m,c as q,P as at,d as ot,L as nt,e as lt,f as dt,g as j,V as ct,h as ht,i as ut,j as ft,W as pt,O as gt,R as mt}from"./vendor-8275f0d3.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function e(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=e(i);fetch(i.href,n)}})();class St{constructor(){a(this,"baseUrl","");a(this,"basePath","/StuffInSpace/images");a(this,"radiusInKm",6371);a(this,"pxToRadius",3185.5);a(this,"addAtmosphere",!1);a(this,"addClouds",!0);a(this,"sphere");a(this,"group")}initClouds(t,e){const s=new w().load(`${this.basePath}/Earth_Cloud.jpg`),i=t.km2pixels(this.radiusInKm+.02),n=new A(i,32,32),o=new M({map:s,opacity:.3,transparent:!0}),d=new G(n,o),l=1.01;d.scale.set(l,l,l),e.add(d)}initAtmosphere(t,e){const s=["varying vec3 vNormal;","varying vec3 vPosition;","void main() {","vNormal = normalize( normalMatrix * normal );","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","vPosition = gl_Position.xyz;","}"].join(`
`),i=["varying vec3 vNormal;","varying vec3 vPosition;","void main() {","  float intensity = pow( 0.8 + dot( vNormal, vec3( 0, 0, 1.0 ) ), 12.0 );","  intensity = min(intensity, 1.7);","  gl_FragColor = vec4( 0.37, 0.71, 0.93, 0.6 ) * intensity;","}"].join(`
`),n=st.clone({}),o=new it({uniforms:n,vertexShader:s,fragmentShader:i,side:rt,blending:z,transparent:!0}),d=t.km2pixels(this.radiusInKm+.1),l=new A(d,32,32),c=new G(l,o),f=1.019;c.scale.set(f,f,f),e.add(c)}init(t,e){e.config&&(this.baseUrl=e.config.baseUrl),this.group=new U;const s=`${this.baseUrl}/images`,i=new w().load(`${s}/earth-blue-marble.jpg`),n=new w().load(`${s}/nightearth-4096.png`),o=new w().load(`${s}/8081_earthbump4k.jpg`),d=new w().load(`${s}/earth-water.png`),l=new M({map:i,bumpMap:o,emissiveMap:n,emissive:new F(8947848),emissiveIntensity:5,specularMap:d,specular:1,shininess:15,bumpScale:1}),c=t.km2pixels(this.radiusInKm),f=new A(c,32,32);this.sphere=new G(f,l),this.group.add(this.sphere),this.addClouds&&this.initClouds(t,this.group),this.addAtmosphere&&this.initAtmosphere(t,this.group),t.add(this.group)}update(){}getMesh(){return this.sphere}}function wt(){return new Worker("/StuffInSpace/assets/SatCruncherWorker-3c37ad1c.js")}const yt="/StuffInSpace",V={appName:"Stuff in Space",baseUrl:yt,propergateInterval:1e3,pushHistory:!1,logLevel:"debug",satelliteGroups:[{id:"GPSGroup",name:"GPS",groupType:"intlDes",data:["90103A","93068A","96041A","97035A","99055A","00025A","00040A","00071A","01004A","03005A","03010A","03058A","04009A","04023A","04045A","05038A","06042A","06052A","07047A","07062A","08012A","09043A","10022A","11036A","12053A","13023A","14008A","14026A","14045A","14068A","15013A"]},{id:"IridiumGroup",name:"Iridium Debris",groupType:"nameRegex",data:/IRIDIUM(?!.*DEB)/},{id:"Iridium33DebrisGroup",name:"Iridium 33 Debris",groupType:"nameRegex",data:/(COSMOS 2251|IRIDIUM 33) DEB/},{id:"GlonassGroup",name:"Glonass",groupType:"nameRegex",data:/GLONASS/},{id:"GalileoGroup",name:"Galileo",groupType:"nameRegex",data:/GALILEO/},{id:"FunGroup",name:"Fun",groupType:"nameRegex",data:/SYLDA/},{id:"WestfordNeedlesGroup",name:"Westford Needles",groupType:"nameRegex",data:/WESTFORD NEEDLES/},{id:"SpaceXGroup",name:"Space X",groupType:"nameRegex",data:/FALCON [19]/},{id:"DebrisGroup",name:"Debris",groupType:"objectType",data:"DEBRIS"},{id:"Starlink",name:"Starlink",groupType:"nameRegex",data:/STARLINK/},{id:"Unknown",name:"Unknown Objects",groupType:"objectType",data:"UNKNOWN"}]},x=["error","warn","info","debug"],y={};let b={};function D(r,t,e,...s){r.enabledOutputs[t]&&e(t.toUpperCase(),...s)}function H(r){const t=x.indexOf(r.toLowerCase());if(t<0)throw new Error("Unknown log level");for(let e=0;e<x.length;e++)y[x[e]]=e<=t}function vt(){return{error:b.error,warn:b.warn,info:b.info,debug:b.debug,setLogLevel:H}}function bt(){b={error:D.bind(this,{enabledOutputs:y},"error",console.error),warn:D.bind(this,{enabledOutputs:y},"warn",console.warn),info:D.bind(this,{enabledOutputs:y},"info",console.info),debug:D.bind(this,{enabledOutputs:y},"debug",console.debug)};for(let r=0;r<x.length;r++)y[x[r]]=!0}bt();H(V.logLevel);const u=vt();class xt{constructor(t,e){a(this,"name");a(this,"colorizer");this.name=t,this.colorizer=e}getSatelliteColor(t){return this.colorizer(t)}}class Dt extends xt{constructor(){super("Default color scheme",t=>{let e=[1,1,0,1],s=!1;return t&&(s=!0,t.OBJECT_TYPE==="PAYLOAD"?e=[1,.2,0,1]:t.OBJECT_TYPE==="ROCKET BODY"?e=[.2,.5,1,.85]:t.OBJECT_TYPE==="DEBRIS"&&(e=[.5,.5,.5,.85])),{color:e,pickable:s}})}}class Lt{constructor(){a(this,"baseUrl","");a(this,"worker");a(this,"currentColorScheme",new Dt);a(this,"numSats",1);a(this,"maxSize",0);a(this,"satPos",new Float32Array);a(this,"satVel",new Float32Array);a(this,"satAlt",new Float32Array);a(this,"cruncherReady",!1);a(this,"scene");a(this,"particles");a(this,"geometry");a(this,"satelliteStore");a(this,"shaderStore");a(this,"selectedSatelliteIdx",-1);a(this,"hoverSatelliteIdx",-1)}setColorScheme(t){this.currentColorScheme=t}updateSatellites(){var t,e;if(this.satPos&&this.satPos.length>0&&this.geometry&&this.geometry.attributes&&(this.geometry.attributes.position&&this.geometry.setAttribute("position",new m(this.satPos,3)),this.geometry.attributes.color&&this.currentColorScheme)){const s=[];if(!this.satelliteStore)return;const i=this.satelliteStore.satData;for(let n=0;n<i.length;n++){const o=((e=(t=this.currentColorScheme)==null?void 0:t.getSatelliteColor(i[n]))==null?void 0:e.color)||[0,0,0];s.push(o[0],o[1],o[2],o[3])}this.geometry.setAttribute("color",new m(s,4))}}onMessage(t){var i;if(!this.satelliteStore)return;const e=this.satelliteStore.getSatData();if(!e)return;let s;try{if(!this.satelliteStore.gotExtraData){const n=performance.now();if(t.data.extraData){if(s=JSON.parse(t.data.extraData),!s)return;for(let o=0;o<this.numSats;o++)e[o].inclination=s[o].inclination,e[o].eccentricity=s[o].eccentricity,e[o].raan=s[o].raan,e[o].argPe=s[o].argPe,e[o].meanMotion=s[o].meanMotion,e[o].semiMajorAxis=s[o].semiMajorAxis,e[o].semiMinorAxis=s[o].semiMinorAxis,e[o].apogee=s[o].apogee,e[o].perigee=s[o].perigee,e[o].period=s[o].period;this.satelliteStore.setSatelliteData(e),u.debug(`sat.js copied extra data in ${performance.now()-n} ms`),this.satelliteStore.setSatelliteData(e,!0);return}}this.satPos=new Float32Array(t.data.satPos),this.satVel=new Float32Array(t.data.satVel),this.satAlt=new Float32Array(t.data.satAlt),this.satelliteStore.setPositionalData(this.satVel,this.satPos,this.satAlt),this.cruncherReady||((i=document.querySelector("#load-cover"))==null||i.classList.add("hidden"),this.cruncherReady=!0),this.updateSatellites()}catch(n){u.debug("Error in worker response",n),u.debug("worker message",t)}}onSatDataLoaded(){if(this.satelliteStore)if(this.worker){const t=JSON.stringify(this.satelliteStore.satData);u.debug("Sending data to sat cruncher worker, to perform work"),this.worker.postMessage(t)}else u.error("worker is not available")}setSelectedSatellite(t){this.selectedSatelliteIdx=t}setHoverSatellite(t){this.hoverSatelliteIdx=t}initGeometry(){if(!this.satelliteStore)throw new Error("satelliteStore is not available");if(!this.shaderStore)throw new Error("sahderStore is not available");const t=new q,e=new Float32Array,s=new Float32Array,i=[];e.fill(0,0,this.satelliteStore.satData.length*3),i.fill(0,0,this.satelliteStore.satData.length*3),s.fill(10,0,this.satelliteStore.satData.length),t.setAttribute("position",new m(e,3)),t.setAttribute("color",new m(i,4)),t.setAttribute("size",new m(s,1)),new w().load(`${this.baseUrl}/images/circle.png`),this.shaderStore.getShader("dot2");const n=new at({color:"grey",size:3,sizeAttenuation:!1,vertexColors:!0,blending:z,depthTest:!0});this.geometry=t,this.particles=new ot(t,n),this.scene&&this.scene.add(this.particles)}getObject3D(){return this.particles}async init(t,e){this.satelliteStore=e.satelliteStore,this.shaderStore=e.shaderStore,this.scene=t,u.info("Kicking off sat-cruncher-worker"),this.worker=new wt,this.worker.onmessage=this.onMessage.bind(this),e!=null&&e.config&&(this.baseUrl=e.config.baseUrl),this.satelliteStore&&(this.satelliteStore.addEventListener("satdataloaded",this.onSatDataLoaded.bind(this)),await this.satelliteStore.loadSatelliteData(),this.initGeometry(),this.satelliteStore.gotExtraData&&this.updateSatellites())}update(){}}function Et(){return new Worker("/StuffInSpace/assets/OrbitCalculationWorker-b9f56d15.js")}class Tt{constructor(){a(this,"segmentCount",255);a(this,"orbitWorker");a(this,"selectedSatelliteIdx",-1);a(this,"hoverSatelliteIdx",-1);a(this,"satelliteGroups");a(this,"satelliteGroup");a(this,"inProgress",[]);a(this,"scene");a(this,"selectColor",[0,1,0,1]);a(this,"hoverColor",[.5,.5,1,1]);a(this,"groupColor",[.3,.5,1,.4]);a(this,"orbitTracks",[]);a(this,"satelliteStore");a(this,"satelliteOrbitGroup")}calculateOrbits(t){t=t.filter(e=>!this.inProgress[e]),this.orbitWorker?this.orbitWorker.postMessage({isInit:!1,satId:t}):u.error("Orbit worker is undefined"),t.forEach(e=>this.inProgress[e]=!0)}onSatellitesLoaded(){this.satelliteStore&&(this.inProgress=new Array(this.satelliteStore.size()),this.orbitTracks=new Array(this.satelliteStore.size()),this.orbitWorker&&this.orbitWorker.postMessage({isInit:!0,satData:JSON.stringify(this.satelliteStore.satData),numSegs:this.segmentCount}))}updateOrbitTrack(t){if(this.orbitTracks[t]){const s=this.orbitTracks[t].material;s.color=this.getTrackColor(t),s.needsUpdate=!0}}removeOrbitTrack(t){var e;if(this.orbitTracks[t]){const s=this.orbitTracks[t];(e=this.satelliteOrbitGroup)==null||e.remove(s),s.geometry&&s.geometry.dispose(),this.orbitTracks[t]=void 0}}getTrackColor(t){let e=[0,0,9];return t===this.hoverSatelliteIdx?e=this.hoverColor:t===this.selectedSatelliteIdx?e=this.selectColor:this.satelliteGroup&&this.satelliteGroup.hasSat(t)&&(e=this.groupColor),new F(e[0],e[1],e[2])}onMessage(t){const{satId:e}=t.data;if(this.scene)if(this.orbitTracks[e])this.orbitTracks[e].geometry.setAttribute("position",new m(t.data.pointsOut,3)),this.updateOrbitTrack(e);else{const s=this.getTrackColor(e),i=new nt({color:s,linewidth:10}),n=new q;n.setAttribute("position",new m(t.data.pointsOut,3));const o=new lt(n,i);this.satelliteOrbitGroup&&this.satelliteOrbitGroup.add(o),this.orbitTracks[e]=o}this.inProgress[e]=!1}setSelectedSatellite(t){this.selectedSatelliteIdx>-1&&(this.orbitTracks[this.selectedSatelliteIdx]&&(!this.satelliteGroup||!this.satelliteGroup.hasSat(this.selectedSatelliteIdx)?this.removeOrbitTrack(this.selectedSatelliteIdx):this.updateOrbitTrack(this.selectedSatelliteIdx)),this.selectedSatelliteIdx=-1),this.selectedSatelliteIdx=t,this.calculateOrbits([t])}setHoverSatellite(t){(this.hoverSatelliteIdx!==void 0&&this.hoverSatelliteIdx>-1||t!==this.hoverSatelliteIdx)&&(!this.satelliteGroup||!this.satelliteGroup.hasSat(this.hoverSatelliteIdx)||this.selectedSatelliteIdx!==this.hoverSatelliteIdx?this.removeOrbitTrack(this.hoverSatelliteIdx):this.updateOrbitTrack(this.hoverSatelliteIdx)),this.hoverSatelliteIdx=t,this.calculateOrbits([t])}setSatelliteGroup(t){if(this.satelliteGroup){this.selectedSatelliteIdx=-1,this.hoverSatelliteIdx=-1;for(let e=0;e<this.orbitTracks.length;e++)this.orbitTracks[e]&&this.removeOrbitTrack(e)}if(this.satelliteGroup=t,this.satelliteGroup){const s=this.satelliteGroup.sats.map(i=>i.satId);this.calculateOrbits(s)}}init(t,e){this.scene=t,this.orbitWorker=new Et,this.orbitWorker.onmessage=this.onMessage.bind(this),this.satelliteStore=e.satelliteStore,this.satelliteStore&&(this.satelliteStore.addEventListener("satdataloaded",this.onSatellitesLoaded.bind(this)),this.satelliteStore.size()>0&&(this.inProgress=new Array(this.satelliteStore.size()),this.onSatellitesLoaded())),e.satelliteGroups&&(this.satelliteGroups=e.satelliteGroups),this.satelliteOrbitGroup=new U,this.scene.add(this.satelliteOrbitGroup)}update(){}}const L=class L extends dt{constructor(){super();a(this,"pxToRadius",3185.5)}setPixels2Radius(e){this.pxToRadius=e}getPixels2Radius(){return this.pxToRadius}km2pixels(e){return e/this.pxToRadius}alitudeToPixels(e){return(L.earthRadiusInKm+e)/this.pxToRadius}};a(L,"earthRadiusInKm",6371);let I=L;class N{constructor(t,e,s,i,n){a(this,"sats",[]);a(this,"id");a(this,"name");a(this,"groupType");a(this,"data");a(this,"satelliteStore");if(this.id=t,this.name=e,this.groupType=s,this.data=i,this.satelliteStore=n,!this.satelliteStore)throw new Error("satelliteStore is required")}reload(){if(this.sats=[],this.groupType==="intlDes")for(let t=0;t<this.data.length;t++)this.sats.push({satId:this.satelliteStore.getIdFromIntlDes(this.data[t]),isIntlDes:!0,strIndex:0});else if(this.groupType==="nameRegex"){const t=this.satelliteStore.searchNameRegex(this.data);for(let e=0;e<t.length;e++)this.sats.push({satId:t[e],isIntlDes:!1,strIndex:0})}else if(this.groupType==="idList")for(let t=0;t<this.data.length;t++)this.sats.push({satId:this.data[t],isIntlDes:!1,strIndex:0});else if(this.groupType==="objectType"){const t="OBJECT_TYPE",e=this.satelliteStore.search({[t]:this.data});for(let s=0;s<e.length;s++)this.sats.push({satId:e[s].id,isIntlDes:!1,strIndex:0})}}getSat(t){return this.satelliteStore.satData.find(e=>e.id===t)}hasSat(t){const e=this.sats.length;for(let s=0;s<e;s++)if(this.sats[s].satId===t)return!0;return!1}}class At{constructor(t,e){a(this,"groups",{});a(this,"selectedGroup");a(this,"sats",[]);a(this,"satelliteStore");if(!e)throw new Error("satelliteStore is required");this.satelliteStore=e,this.resetConfig(t),this.satelliteStore.addEventListener("satdataloaded",this.onSatDataLoaded.bind(this))}asArray(){return Object.values(this.groups)}selectGroup(t){if(this.selectedGroup=t,!t){this.clearSelect();return}}forEach(t){for(let e=0;e<this.sats.length;e++)t(this.sats[e].satId)}clearSelect(){this.selectedGroup=void 0}getGroupById(t){if(t)return t=t.toLowerCase(),this.groups[t]}getSelectedGroup(){return this.selectedGroup}reloadGroups(){const t=Object.keys(this.groups);for(let e=0;e<t.length;e++)this.groups[t[e]].reload()}resetConfig(t){const e=t;for(let s=0;s<e.length;s++)u.debug(`registering satellite group ${e[s].name} (id: ${e[s].id})`),this.groups[e[s].id.toLowerCase()]=new N(e[s].id.toLowerCase(),e[s].name,e[s].groupType,e[s].data,this.satelliteStore)}onSatDataLoaded(){this.reloadGroups()}}class _{constructor(t){a(this,"listeners",{});a(this,"supportedEvents");this.supportedEvents=t}addEventListener(t,e){if(!t)throw new Error("eventName must not be undefined");if(this.supportedEvents&&this.supportedEvents.indexOf(t)<0)throw new Error(`unsupported event ${t}`);if(t=t.toLowerCase(),this.listeners[t]||(this.listeners[t]=new Set),this.listeners[t])this.listeners[t].add(e);else throw new Error("unknown event")}fireEvent(t,e){if(!t)throw new Error("undefined eventName");t=t.toLowerCase(),this.listeners[t]&&this.listeners[t].forEach(i=>{i(e)})}}const Gt={baseUrl:"/StuffInSpace"};class It{constructor(t={}){a(this,"tleUrl",`${Gt.baseUrl}/data/attributed-TLE.json`);a(this,"eventManager");a(this,"satData",[]);a(this,"attribution");a(this,"updateDate");a(this,"satelliteVelocities",new Float32Array);a(this,"satellitePositions",new Float32Array);a(this,"satelliteAltitudes",new Float32Array);a(this,"gotExtraData",!1);a(this,"gotPositionalData",!1);a(this,"loaded",!1);this.eventManager=new _,t.tleUrl&&(this.tleUrl=t.tleUrl)}async loadSatelliteData(){u.debug("Loading satellite data");try{const t=await j.get(this.tleUrl,{params:{t:Date.now()}});if(t.data){Array.isArray(t.data)?this.satData=t.data:(this.satData=t.data.data,this.attribution=t.data.source,this.updateDate=t.data.date);for(let e=0;e<this.satData.length;e++){if(this.satData[e].INTLDES){let s=this.satData[e].INTLDES.substring(0,2);s=(s>50?"19":"20")+s;const n=this.satData[e].INTLDES.substring(2);this.satData[e].intlDes=`${s}-${n}`}else this.satData[e].intlDes="unknown";this.satData[e].id=e}}this.eventManager.fireEvent("satdataloaded",this.satData),this.loaded=!0}catch(t){u.error("error loading TLE data",t)}}getAttribution(){return this.attribution}getUpdatedDate(){return this.updateDate}setSatelliteData(t,e=!1){this.satData=t,this.gotExtraData=e,e&&this.eventManager.fireEvent("satextradataloaded",this.satData)}setPositionalData(t,e,s){this.satelliteVelocities=t,this.satellitePositions=e,this.satelliteAltitudes=s,this.gotPositionalData=!0}getSatellitePosition(t){const e=t*3;if(this.satellitePositions&&e<this.satellitePositions.length)return[this.satellitePositions[e],this.satellitePositions[e+1],this.satellitePositions[e+3]]}getSatData(){return this.satData||[]}getPositions(){return this.satellitePositions}getAltitudes(){return this.satelliteAltitudes}getVelocitities(){return this.satelliteVelocities}size(){return this.satData.length}searchNameRegex(t){const e=[];for(let s=0;s<this.satData.length;s++)t.test(this.satData[s].OBJECT_NAME)&&e.push(s);return e}search(t){const e=Object.keys(t);let s=Object.assign([],this.satData);for(let i=0;i<e.length;i++){const n=e[i];s=s.filter(o=>o[n]===t[n])}return s}searchName(t){const e=[];for(let s=0;s<this.satData.length;s++)this.satData[s].OBJECT_NAME===t&&e.push(s);return e}getIdFromIntlDes(t){for(let e=0;e<this.satData.length;e++)if(this.satData[e].INTLDES===t||this.satData[e].intlDes===t)return e;return null}getSatellite(t){if(!t||t===-1||!this.satData)return;const e=this.satData[t];if(e)return this.gotPositionalData&&(e.altitude=this.satelliteAltitudes[t],e.velocity=Math.sqrt(this.satelliteVelocities[t*3]*this.satelliteVelocities[t*3]+this.satelliteVelocities[t*3+1]*this.satelliteVelocities[t*3+1]+this.satelliteVelocities[t*3+2]*this.satelliteVelocities[t*3+2]),e.position={x:this.satellitePositions[t*3],y:this.satellitePositions[t*3+1],z:this.satellitePositions[t*3+2]}),e}addEventListener(t,e){this.eventManager.addEventListener(t,e)}}class Ot{constructor(t=""){a(this,"baseUrl","/shaders");a(this,"shaders",["earth-fragment","earth-vertex","dot-fragment","dot-vertex","dot2-fragment","dot2-vertex","pick-fragment","pick-vertex","path-fragment","path-vertex"]);a(this,"shaderData",{});this.baseUrl=`${t}${this.baseUrl}`}async loadShader(t){const e=`${this.baseUrl}/${t}.glsl`;u.debug(`loading shader from ${e}`);const s=await j.get(e);if(s.data)return s.data;throw new Error("no data received")}async load(){try{for(let t=0;t<this.shaders.length;t++){const e=await this.loadShader(this.shaders[t]);this.shaderData[this.shaders[t]]=e}}catch(t){u.error("Errors while loading shaders",t)}}addShader(t,e,s){this.shaderData[`${t}-fragment`]=e,this.shaderData[`${t}-vertex`]=s}getFragmentShader(t){return this.shaderData[`${t}-fragment`]}getVertexShader(t){return this.shaderData[`${t}-vertex`]}getShader(t){return{vertex:this.getVertexShader(t),fragment:this.getFragmentShader(t)}}}class Ct{constructor(t){a(this,"config",{canvasSelector:".viewer"});a(this,"sceneComponents",[]);a(this,"sceneComponentsByName",{});a(this,"scene");a(this,"camera");a(this,"controls");a(this,"renderer");a(this,"context",{});a(this,"satelliteGroups");a(this,"satelliteStore");a(this,"shaderStore");a(this,"selectedSatelliteIdx",-1);a(this,"eventManager",new _);a(this,"ready",!1);a(this,"raycaster");a(this,"showRaycastArrow",!0);a(this,"raycastArrow");a(this,"satellites");a(this,"orbits");a(this,"earth");this.config={...t,...this.config}}async registerSceneComponent(t,e){u.debug(`Registering scene component ${t}`),this.sceneComponents.push(e),this.sceneComponentsByName[t]=e,await e.init(this.scene,this.context)}getCenterPoint(t){if(t){const e=t.geometry;e.computeBoundingBox();const s=new ct;if(e.boundingBox)return e.boundingBox.getCenter(s),t.localToWorld(s),s}}onWindowResize(){this.camera&&(this.camera.aspect=window.innerWidth/window.innerHeight,this.camera.updateProjectionMatrix()),this.renderer&&this.renderer.setSize(window.innerWidth,window.innerHeight)}onSatDataLoaded(t){this.eventManager.fireEvent("satdataloaded",t),this.ready=!0}onClick(t){var o;const e=(o=this.renderer)==null?void 0:o.domElement;if(!this.raycaster||!this.scene||!this.camera||!e)return;this.raycaster.params.Points.threshold=2;const s=e.getBoundingClientRect(),i=new ht;i.x=(t.clientX-s.left)/e.clientWidth*2-1,i.y=-((t.clientY-s.top)/e.clientHeight*2)+1,this.raycaster.setFromCamera(i,this.camera),this.raycastArrow&&(this.scene.remove(this.raycastArrow),this.raycastArrow.dispose(),this.raycastArrow=void 0),this.raycastArrow=new ut(this.raycaster.ray.direction,this.raycaster.ray.origin,300,16776960,void 0,1),this.scene.add(this.raycastArrow);const n=this.raycaster.intersectObjects(this.scene.children,!0);n.length>0&&console.log("XXXXX insersects",n)}async init(){var s;this.scene=new I,this.camera=new ft(45,window.innerWidth/window.innerHeight,.1,1e3),this.renderer=new pt({antialias:!1}),this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.setSize(window.innerWidth,window.innerHeight),(s=document.querySelector(this.config.canvasSelector))==null||s.appendChild(this.renderer.domElement),this.controls=new gt(this.camera,this.renderer.domElement),this.controls.zoomSpeed=.1,this.camera.position.set(15,0,-100),this.controls.update(),this.camera.position.y=5,this.camera.zoom=5,this.raycaster=new mt,this.satelliteStore=new It(this.config),this.satelliteGroups=new At(this.config.satelliteGroups,this.satelliteStore),this.shaderStore=new Ot(this.config.baseUrl),u.debug("loading shaders"),await this.shaderStore.load(),this.context.satelliteGroups=this.satelliteGroups,this.context.config=this.config,this.context.satelliteStore=this.satelliteStore,this.context.shaderStore=this.shaderStore,this.satelliteStore.addEventListener("satdataloaded",this.onSatDataLoaded.bind(this)),this.earth=new St,this.satellites=new Lt,await this.registerSceneComponent("satellites",this.satellites),this.orbits=new Tt;const t=this.getCenterPoint(this.earth.getMesh());t&&(this.controls.target=t),this.camera.position.y=42,this.controls.minDistance=4,this.controls.maxDistance=100,this.controls.enablePan=!1,this.controls.enableDamping=!0,this.camera.updateProjectionMatrix(),window.addEventListener("resize",this.onWindowResize.bind(this)),this.renderer.domElement.addEventListener("click",this.onClick.bind(this))}animate(){requestAnimationFrame(this.animate.bind(this));for(let t=0;t<this.sceneComponents.length;t++)this.sceneComponents[t].update(this.scene);this.controls&&this.controls.update(),this.renderer&&this.renderer.render(this.scene,this.camera)}getSatelliteStore(){return this.satelliteStore}getSatelliteGroups(){return this.satelliteGroups}zoomToSatellite(t){var e;(e=this.satelliteStore)==null||e.getSatellitePosition(t)}zoomIn(){if(this.camera){const t=this.camera.zoom+1.2,e=20,s=()=>{this.camera&&this.camera.zoom<t&&(this.camera.zoom+=.02,this.camera.updateProjectionMatrix(),setTimeout(s,e))};setTimeout(s,e)}}zoomOut(){if(this.camera){const t=this.camera.zoom-1.2,e=20,s=()=>{this.camera&&this.camera.zoom>t&&(this.camera.zoom-=.02,this.camera.updateProjectionMatrix(),setTimeout(s,e))};setTimeout(s,e)}}setHoverSatellite(t){var e,s;(e=this.satellites)==null||e.setHoverSatellite(t),(s=this.orbits)==null||s.setHoverSatellite(t)}setSelectedSatellite(t){var e,s;(e=this.satellites)==null||e.setSelectedSatellite(t),(s=this.orbits)==null||s.setSelectedSatellite(t)}setSelectedSatelliteGroup(t){var e,s;(e=this.satelliteGroups)==null||e.selectGroup(t),(s=this.orbits)==null||s.setSatelliteGroup(t)}getSelectedSatellite(){if(this.satelliteStore)return this.satelliteStore.getSatellite(this.selectedSatelliteIdx)}getSelectedSatelliteIdx(){return this.selectedSatelliteIdx}addEventListener(t,e){this.eventManager.addEventListener(t,e)}}function kt(r){return new Ct(r)}const P={satMovementChange:"satMovementChange",selectedSatChange:"selectedSatChange",satHover:"sathover",satDataLoaded:"satdataloaded",closeWindow:"closeWindow",cruncherReady:"cruncherReady"};class Mt{constructor(t,e={}){a(this,"element");a(this,"id");a(this,"options");a(this,"listeners",{});a(this,"firstOpen",!0);a(this,"windowManager");this.element=document.querySelector(`#${t}`),this.id=t,this.options=e,this.listeners={},this.firstOpen=!0,this.initEvents()}setWindowManager(t){this.windowManager=t}open(){this.element&&(this.firstOpen=!1,this.element.classList.add("active"),this.element.classList.add("visible"),this.element.classList.remove("hidden"),this.windowManager.bringWindowToFront(this))}close(){this.element&&(this.element.classList.remove("active"),this.element.classList.remove("visible"),this.element.classList.add("hidden"))}isOpen(){return this.element?this.element.classList.contains("visible"):!1}initEvents(){if(!this.element)return;const t=this.element.querySelector(".window-close");t&&t.addEventListener("click",()=>{this.close()})}moveTo(t,e){this.element&&(this.element.style.top=`${e}px`,this.element.style.left=`${t}px`)}getLocation(){if(!this.element)return{x:0,y:0};const t=this.element.style;return t.x?{x:t.x,y:t.y}:{x:this.element.offsetLeft,y:this.element.offsetTop}}addEventListener(t,e){if(this.listeners[t]||(this.listeners[t]=new Set),this.listeners[t])this.listeners[t].add(e);else throw new Error("unknown event")}fireEvent(t,e){this.listeners[t]&&this.listeners[t].forEach(i=>{i(e)})}}const Pt=100;class Rt{constructor(){a(this,"windows",[]);a(this,"windowsById",{});a(this,"initialOpen",!1)}bringWindowToFront(t){const e=t.element;let s=-1;for(let i=0;i<this.windows.length;i++)if(this.windows[i].id===(e==null?void 0:e.id)){s=i;break}s>-1&&(this.windows.splice(s,1),this.windows.push(t));for(let i=0;i<this.windows.length;i++){const n=this.windows[i];n&&n.element&&n.element.style&&(n.element.style.zIndex=Pt+i+1)}}registerWindow(t,e={}){const s=new Mt(t,e);s.setWindowManager(this),this.windows.push(s),this.windowsById[t]=s,this.makeDraggable(s)}getTopWindow(){for(let t=this.windows.length-1;t>=0;t--)if(this.windows[t].isOpen())return this.windows[t]}openWindow(t){const s={x:100,y:100},i=this.windowsById[t],n=this.getTopWindow();let o=!1;if(i){let{x:d,y:l}=i.getLocation();if(n||(d=s.x,l=s.y,this.initialOpen=!1),o=i.firstOpen,o&&n){const c=n.getLocation();c&&(d=c.x+42,l=c.y+42)}if(i.open(),!this.initialOpen&&!o){const c=i.getLocation();c&&(d=c.x,l=c.y)}(d>window.innerWidth||d<0)&&(d=s.x),(l>window.innerHeight||l<0)&&(l=s.y),this.bringWindowToFront(i),i.moveTo(d,l),this.initialOpen=!1}}closeWindow(t){const e=this.windowsById[t];e&&e.close()}makeDraggable(t){let e=0,s=0,i=0,n=0;const o=t.element;if(!o)return;const d=o.querySelector(".drag-zone")||o;function l(c){const f=`${e-(n-c.clientY)}px`,v=`${s-(i-c.clientX)}px`;o&&o.style&&(o.style.top=f,o.style.left=v)}o.classList.add("draggable"),o.addEventListener("click",()=>{this.bringWindowToFront(t)}),d.addEventListener("mousedown",c=>{c.preventDefault(),s=o.offsetLeft,e=o.offsetTop,i=c.clientX,n=c.clientY,this.bringWindowToFront(t),o.style.right="unset",o.style.bottom="unset",o.style.left=`${s}px`,o.style.top=`${e}px`,o.classList.add("dragging"),d.addEventListener("mousemove",l)}),o.addEventListener("mouseup",c=>{c.preventDefault(),d.removeEventListener("mousemove",l),o.classList.remove("dragging")}),o.addEventListener("mouseout",c=>{c.preventDefault(),d.removeEventListener("mousemove",l),o.classList.remove("dragging")})}}const R=200;let p,O,J=!1,C=-1,E=!1,K;function X(){return E}function Wt(){return K}function $t(){return E?document.querySelector("#search").value:null}function Bt(){return J}function zt(){return C}function Ut(){J=!1,C=-1,p.setHoverSatellite(C)}function T(r){const t=document.querySelector("#search-results");t&&(r?t.style.display="block":t.style.display="none",E=r)}function Ft(){T(!X())}function qt(){T(!0)}function Y(){T(!1);const r=p.getSatelliteGroups();r&&r.clearSelect()}function Z(r,t){const e=document.querySelector("#search-results"),s=p.getSatelliteStore();if(!s)return;let i="";for(let n=0;n<r.length;n++){if(r[n].satId===void 0)continue;const o=s.getSatellite(r[n].satId);if(!o){u.warn("satellite not found",r[n].satId);continue}i+=`<div class="search-result" data-sat-id="${o.id}">`,r[n].isIntlDes?i+=o.OBJECT_NAME:(i+=o.OBJECT_NAME.substring(0,r[n].strIndex),i+='<span class="search-hilight">',i+=o.OBJECT_NAME.substring(r[n].strIndex,r[n].strIndex+t.length),i+="</span>",i+=o.OBJECT_NAME.substring(r[n].strIndex+t.length)),i+='<div class="search-result-intldes">',r[n].isIntlDes?(i+=o.intlDes.substring(0,r[n].strIndex),i+='<span class="search-hilight">',i+=o.intlDes.substring(r[n].strIndex,r[n].strIndex+t.length),i+="</span>",i+=o.intlDes.substring(r[n].strIndex+t.length)):i+=o.intlDes,i+="</div></div>"}e.innerHTML=i,e.style.display="block",E=!0}function jt(){const r=document.querySelector("#search-results");r&&(r.innerHTML="")}function k(r){var d;const t=p.getSatelliteStore();if(!t)return;const e=t.getSatData();if(p.setSelectedSatellite(-1),r.length===0){Y();return}r=r.toUpperCase();const s=[];for(let l=0;l<e.length;l++)((d=e[l])==null?void 0:d.OBJECT_NAME.indexOf(r))!==-1&&s.push({isIntlDes:!1,strIndex:e[l].OBJECT_NAME.indexOf(r),satId:l}),e[l].intlDes&&e[l].intlDes.indexOf(r)!==-1&&(console.log(e[l]),s.push({isIntlDes:!0,strIndex:e[l].intlDes.indexOf(r),satId:l}));s.length>R&&(s.length=R);const i=[];for(let l=0;l<s.length;l++)i.push(s[l].satId);const n=new N("search-results","Search Results","idList",i,t);n.reload(),K=n;const o=p.getSatelliteGroups();o&&o.selectGroup(n),Z(s,r)}function Vt(){var t,e;const r=document.querySelector("#search-results");r&&(r.addEventListener("click",s=>{const n=s.target.dataset.satId;Ut(),p.setSelectedSatellite(n)}),(t=document.querySelector("#search"))==null||t.addEventListener("input",()=>{var i;const s=(i=document.querySelector("#search"))==null?void 0:i.value;k(s)}),(e=document.querySelector("#all-objects-link"))==null||e.addEventListener("click",()=>{const s=p.getSelectedSatellite();if(s){const n=s.intlDes.slice(0,8);k(n),document.querySelector("#search").value=n,O&&O.openWindow("search-window")}}))}function Ht(r,t){p=r,O=t,Vt()}const S={init:Ht,clearResults:jt,getHoverSat:zt,isHovering:Bt,showResults:qt,hideResults:Y,doSearch:k,getCurrentSearch:$t,getLastResultGroup:Wt,fillResultBox:Z,isResultBoxOpen:X,setResultsVisible:T,toggleResultsVisible:Ft},Nt=[],g=new Rt,_t=[];let W=!1,h;function Jt(r){var e;let t=document.querySelector(".attribution");if(t||(t=document.createElement("div"),t.className="attribution",(e=document.querySelector("body"))==null||e.appendChild(t)),t)if(r){const s=h.getSatelliteStore();if(s&&s.getAttribution()){const i=s.getAttribution()||{},n=s.getUpdatedDate();t.innerHTML=`Orbital object data from <a href="${i.url}">${i.name}</a> <span class="updated">(updated ${n})</span>`}t.classList.remove("hidden")}else t.classList.add("hidden")}function Q(r){var t,e;r?(t=document.querySelector("body"))==null||t.classList.add("loading"):(e=document.querySelector("body"))==null||e.classList.remove("loading")}function Kt(){const r=document.querySelector("#groups-display"),t=h.getSatelliteGroups();let e=[];t&&(e=t.asArray().sort((i,n)=>i.name.localeCompare(n.name)));let s="";for(let i=0;i<e.length;i++)s+=`<li data-group="${e[i].id}" id="satgroup-${e[i].id}" class="clickable">${e[i].name}</li>
`;r.innerHTML=s}function $(r,t){const e=document.querySelector(r);e&&(e.innerHTML=t)}function Xt(){var t;(t=document.querySelector("#groups-display"))==null||t.addEventListener("mouseout",()=>{if(!W){const e=h.getSatelliteGroups();e&&(S.isResultBoxOpen()?e.selectGroup(S.getLastResultGroup()):e.clearSelect())}});const r=document.querySelectorAll("#groups-display>li");for(let e=0;e<r.length;e++){const s=r[e];s.addEventListener("mouseover",i=>{const o=i.currentTarget.dataset.group,d=h.getSatelliteGroups();d&&d.selectGroup(d.getGroupById(o))}),s.addEventListener("mouseout",()=>{const i=h.getSatelliteGroups();if(i){const n=document.querySelector("#groups-display>li.selected");n?i.selectGroup(i.getGroupById(n.dataset.group)):i.selectGroup(void 0)}}),s.addEventListener("click",i=>{i.preventDefault();const n=i.currentTarget;W=!0;const o=document.querySelector("#groups-display>li.selected");let d;o&&(d=o.dataset.group),console.dir(i.target);for(let v=0;v<r.length;v++)r[v].classList.remove("selected");const l=h.getSatelliteGroups(),c=n.dataset.group;let f;c===d?(l&&l.clearSelect(),S.clearResults(),S.hideResults()):(i.preventDefault(),i.stopPropagation(),l&&(h.setSelectedSatellite(-1),l&&(f=l.getGroupById(c)),f&&(n.classList.add("selected"),S.fillResultBox(f.sats,""),g.openWindow("search-window"),f.reload()))),l&&(l.selectGroup(f),h.setSelectedSatelliteGroup(f))})}}function Yt(){var t,e;const r=h.getSatelliteGroups();r==null||r.reloadGroups(),(t=document.querySelector("#zoom-in"))==null||t.addEventListener("click",s=>{s.preventDefault(),h.zoomIn()}),(e=document.querySelector("#zoom-out"))==null||e.addEventListener("click",s=>{s.preventDefault(),h.zoomOut()}),window.addEventListener("resize",()=>{_t.forEach(s=>{window.visualViewport&&(s.offsetLeft+s.offsetWidth>window.visualViewport.width&&(s.style.right="unset",s.style.left=`${window.visualViewport.width-s.offsetWidth}px`),s.offsetTop+s.offsetHeight>window.visualViewport.height&&(s.style.bottom="unset",s.style.offsetTop=`${window.visualViewport.height-s.offsetHeight}px`))})}),Q(!1)}function Zt(r){r.satId&&($("#sat-altitude",`${r.altitude.toFixed(2)} km`),$("#sat-velocity",`${r.velocity.toFixed(2)} km/s`))}function B(){Yt(),Kt(),setTimeout(()=>Xt(),0);const r=document.querySelector("#load-cover");r&&r.classList.add("hidden"),Jt(!0)}function Qt(){return Nt}function te(){const r=document.querySelectorAll(".menu-item");for(let t=0;t<r.length;t++){const e=r[t];e.addEventListener("click",()=>{const s=e.dataset.action;if(s&&s.startsWith("open:")){const i=s.split(":");g.openWindow(i[1])}})}}function ee(){return S.getCurrentSearch()}function se(r){h=r,g.registerWindow("sat-infobox"),g.registerWindow("about-window"),g.registerWindow("help-window"),g.registerWindow("groups-window"),g.registerWindow("search-window"),S.init(h,g),te(),h.addEventListener(P.satMovementChange,Zt),h.ready?B():h.addEventListener(P.satDataLoaded,B)}const ie={setLoading:Q,init:se,getSupportedEvents:Qt,getCurrentSearch:ee};async function re(){const r=kt(V);await r.init(),r.animate(),ie.init(r)}document.addEventListener("DOMContentLoaded",()=>{re().catch(r=>console.error(r))});
